<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Haunted Monitor</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    #stage { position: relative; width: 100vw; height: 100vh; overflow: hidden; background:#000; }
    #stage > video, #stage > img, .magnet-line { position: absolute; left:0; top:0; width:100%; height:100%; }
    #bg        { z-index: 5;  object-fit: cover; }
    #scrambled { z-index: 10; opacity: 1; transition: opacity 220ms linear; }  /* start visible */
    .magnet-line { z-index: 15; display:flex; justify-content:center; align-items:center; gap:0.75rem; }
    #wordLayer { transform: translateY(0rem); }
    #ofLayer   { transform: translateY(2.4rem); }
    #suitLayer { transform: translateY(4.8rem); }
    #grain     { z-index: 20; mix-blend-mode: screen; opacity: 0.75; object-fit: cover; }
    #glitch    { z-index: 30; display:none; object-fit: cover; }
    .magnet { height: 11vh; width: auto; user-select:none; -webkit-user-drag:none; image-rendering:auto; }
    .spacer { width: 3vh; }
  </style>
</head>
<body>
  <div id="stage">
    <video id="bg" playsinline muted loop autoplay preload="auto" src="background.mp4"></video>
    <img id="scrambled" src="scrambled.png" alt=""/>
    <div id="wordLayer" class="magnet-line"></div>
    <div id="ofLayer" class="magnet-line"></div>
    <div id="suitLayer" class="magnet-line"></div>
    <video id="grain" playsinline muted loop autoplay preload="auto" src="grain.mp4"></video>
    <video id="glitch" playsinline muted preload="metadata" src="glitch.mp4"></video>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

    // --- Firebase config you gave me ---
    const firebaseConfig = {
      apiKey: "AIzaSyBrePZ1A0Kux-5kI9IBxWBkFQzaOBnBaA8",
      authDomain: "haunted-monitor.firebaseapp.com",
      databaseURL: "https://haunted-monitor-default-rtdb.firebaseio.com",
      projectId: "haunted-monitor",
      storageBucket: "haunted-monitor.firebasestorage.app",
      messagingSenderId: "469649621539",
      appId: "1:469649621539:web:0200310ee852d37e2de796"
    };
    const app = initializeApp(firebaseConfig);
    const db  = getDatabase(app);

    // --- Elements ---
    const qs = new URLSearchParams(location.search);
    const room = qs.get('room') || 'demo';

    const wordLayer = document.getElementById('wordLayer');
    const ofLayer   = document.getElementById('ofLayer');
    const suitLayer = document.getElementById('suitLayer');
    const scrambled = document.getElementById('scrambled');
    const bg        = document.getElementById('bg');
    const grain     = document.getElementById('grain');
    const glitch    = document.getElementById('glitch');

    // Hide missing optional media gracefully
    [bg, grain, scrambled, glitch].forEach(el => {
      if (!el) return;
      el.addEventListener('error', () => { el.style.display = 'none'; });
    });

    // Helpers
    function clearLayer(layer) { while (layer.firstChild) layer.removeChild(layer.firstChild); }
    function setScrambleVisible(show) { if (scrambled) scrambled.style.opacity = show ? 1 : 0; }

    function addMagnetChar(layer, ch) {
      if (ch === ' ') { const spacer = document.createElement('div'); spacer.className='spacer'; layer.appendChild(spacer); return; }
      const upper = ch.toUpperCase();
      if (upper < 'A' || upper > 'Z') { const spacer = document.createElement('div'); spacer.className='spacer'; layer.appendChild(spacer); return; }
      const img = document.createElement('img');
      img.draggable = false;
      img.className = 'magnet';
      img.src = `letters/${upper}.png`;
      img.onerror = () => { img.style.display='none'; }; // if letter missing, don’t break layout
      // tiny organic wobble
      const rot = (Math.random()*4 - 2);
      const jitter = (Math.random()*2 - 1);
      img.style.transform = `rotate(${rot}deg)`;
      img.style.marginTop = `${jitter}px`;
      layer.appendChild(img);
    }

    function renderWord(phrase) {
      clearLayer(ofLayer); clearLayer(suitLayer); clearLayer(wordLayer);
      for (const ch of (phrase || '').toUpperCase()) addMagnetChar(wordLayer, ch);
      setScrambleVisible(false);
    }

    function renderCard(value, suit) {
      clearLayer(wordLayer); clearLayer(ofLayer); clearLayer(suitLayer);
      for (const ch of (value || '').toUpperCase()) addMagnetChar(wordLayer, ch);
      for (const ch of 'OF') addMagnetChar(ofLayer, ch);
      for (const ch of (suit || '').toUpperCase()) addMagnetChar(suitLayer, ch);
      setScrambleVisible(false);
    }

    // Glitch burst wrapper — only if asset exists
    function glitchThen(fn) {
      if (!glitch || glitch.style.display === 'none' || !glitch.src) { fn(); return; }
      glitch.currentTime = 0;
      glitch.style.display = 'block';
      // Safety timer in case onended never fires
      const safety = setTimeout(done, 1500);
      glitch.onended = done;
      glitch.play().catch(done);

      function done() {
        clearTimeout(safety);
        glitch.pause();
        glitch.style.display = 'none';
        fn();
      }
    }

    // --- Debounce / ignore stale commands ---
    // We only react when `seq` increases.
    let lastSeq = Number(localStorage.getItem(`hm_seq_${room}`) || 0);

    onValue(ref(db, `haunt/${room}`), (snap) => {
      const v = snap.val();
      if (!v) return;
      const seq = Number(v.seq || 0);
      // If this is the first load and there's already data, ignore it unless seq is newer
      if (!(seq > lastSeq)) return;
      lastSeq = seq;
      localStorage.setItem(`hm_seq_${room}`, String(lastSeq));

      if (v.mode === 'WORD') {
        glitchThen(() => renderWord(v.word || ''));
      } else if (v.mode === 'CARD') {
        glitchThen(() => renderCard(v.value || '', v.suit || ''));
      } else if (v.mode === 'SCRAMBLE') {
        setScrambleVisible(true);
      } else {
        // IDLE or anything else → show scramble
        setScrambleVisible(true);
      }
    });

    // Tap anywhere to re-show the scrambled overlay during rehearsal
    document.body.addEventListener('click', () => setScrambleVisible(true));
  </script>
</body>
</html>
