<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Haunted Monitor</title>
  <link rel="stylesheet" href="style.css"/>
</head>
<body>
  <div id="stage">
    <video id="bg" playsinline muted loop autoplay preload="auto" src="background.mp4"></video>
    <img id="scrambled" src="scrambled.png" alt="" />
    <div id="wordLayer" class="magnet-line"></div>
    <div id="ofLayer" class="magnet-line"></div>
    <div id="suitLayer" class="magnet-line"></div>
    <video id="grain" playsinline muted loop autoplay preload="auto" src="grain.mp4"></video>
  </div>

  <!-- Firebase SDKs -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
    import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';
    const firebaseConfig = {
  "apiKey": "AIzaSyBrePZ1A0Kux-5kI9IBxWBkFQzaOBnBaA8",
  "authDomain": "haunted-monitor.firebaseapp.com",
  "databaseURL": "https://haunted-monitor-default-rtdb.firebaseio.com",
  "projectId": "haunted-monitor",
  "storageBucket": "haunted-monitor.firebasestorage.app",
  "messagingSenderId": "469649621539",
  "appId": "1:469649621539:web:0200310ee852d37e2de796"
};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Utils
    const qs = new URLSearchParams(location.search);
    const room = qs.get('room') || 'demo';
    const wordLayer = document.getElementById('wordLayer');
    const ofLayer = document.getElementById('ofLayer');
    const suitLayer = document.getElementById('suitLayer');
    const scrambled = document.getElementById('scrambled');
    const bg = document.getElementById('bg');
    const grain = document.getElementById('grain');

    // Hide missing optional media gracefully
    bg.addEventListener('error', () => bg.style.display='none');
    grain.addEventListener('error', () => grain.style.display='none');
    scrambled.addEventListener('error', () => scrambled.style.display='none');

    function clearLayer(layer) { while (layer.firstChild) layer.removeChild(layer.firstChild); }

    function addMagnetChar(layer, ch) {
      if (ch === ' ') {
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        layer.appendChild(spacer);
        return;
      }
      const img = document.createElement('img');
      img.draggable = false;
      img.className = 'magnet';
      const upper = ch.toUpperCase();
      if (upper >= 'A' && upper <= 'Z') {
        img.src = `letters/${upper}.png`;
      } else {
        const spacer = document.createElement('div');
        spacer.className = 'spacer';
        layer.appendChild(spacer);
        return;
      }
      const rot = (Math.random()*4 - 2);
      const jitter = (Math.random()*2 - 1);
      img.style.transform = `rotate(${rot}deg)`;
      img.style.marginTop = `${jitter}px`;
      layer.appendChild(img);
    }

    function showWord(phrase) {
      scrambled.style.opacity = 0;
      clearLayer(ofLayer); clearLayer(suitLayer);
      clearLayer(wordLayer);
      for (const ch of phrase.toUpperCase()) addMagnetChar(wordLayer, ch);
    }

    function showCard(value, suit) {
      scrambled.style.opacity = 0;
      clearLayer(wordLayer); clearLayer(ofLayer); clearLayer(suitLayer);
      for (const ch of value.toUpperCase()) addMagnetChar(wordLayer, ch);
      for (const ch of 'OF') addMagnetChar(ofLayer, ch);
      for (const ch of suit.toUpperCase()) addMagnetChar(suitLayer, ch);
    }

    onValue(ref(db, `haunt/${room}`), (snap) => {
      const v = snap.val();
      if (!v) return;
      if (v.mode === 'WORD') showWord(v.word || '');
      if (v.mode === 'CARD') showCard(v.value || '', v.suit || '');
    });

    document.body.addEventListener('click', () => { scrambled.style.opacity = 1; });
  </script>
</body>
</html>
