<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Haunted Monitor</title>
  <link rel="stylesheet" href="style.css"/>
  <style>
    /* Safety z-order in case style.css is missing */
    #stage { position: relative; width: 100vw; height: 100vh; overflow: hidden; background:#000; }
    #stage > video, #stage > img, .magnet-line { position:absolute; left:0; top:0; width:100%; height:100%; }
    #bg     { z-index: 5;  object-fit: cover; }
    #scrambled { z-index: 10; opacity: 1; transition: opacity 280ms linear; }
    .magnet-line { z-index: 15; display:flex; justify-content:center; align-items:center; gap:0.75rem; pointer-events:none; }
    #ofLayer   { transform: translateY(2.4rem); }
    #suitLayer { transform: translateY(4.8rem); }
    .magnet { height: 11vh; width:auto; user-select:none; -webkit-user-drag:none; }
    .spacer { width: 3vh; }
    #grain  { z-index: 20; mix-blend-mode: screen; opacity: .75; object-fit: cover; }
    #glitch { z-index: 30; display:none; object-fit: cover; }
  </style>
</head>
<body>
  <div id="stage">
    <video id="bg" playsinline muted loop autoplay preload="auto" src="background.mp4"></video>
    <img id="scrambled" src="scrambled.png" alt=""/>
    <div id="wordLayer" class="magnet-line"></div>
    <div id="ofLayer"   class="magnet-line"></div>
    <div id="suitLayer" class="magnet-line"></div>
    <video id="grain"  playsinline muted loop autoplay preload="auto" src="grain.mp4"></video>
    <video id="glitch" playsinline muted preload="auto" src="glitch.mp4"></video>
  </div>

<script type="module">
  import { initializeApp }   from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js';
  import { getDatabase, ref, onValue } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js';

  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyBrePZ1A0Kux-5kI9IBxWBkFQzaOBnBaA8",
    authDomain: "haunted-monitor.firebaseapp.com",
    databaseURL: "https://haunted-monitor-default-rtdb.firebaseio.com",
    projectId: "haunted-monitor",
    storageBucket: "haunted-monitor.firebasestorage.app",
    messagingSenderId: "469649621539",
    appId: "1:469649621539:web:0200310ee852d37e2de796"
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // --- Elements ---
  const wordLayer = document.getElementById('wordLayer');
  const ofLayer   = document.getElementById('ofLayer');
  const suitLayer = document.getElementById('suitLayer');
  const scrambled = document.getElementById('scrambled');
  const bg        = document.getElementById('bg');
  const grain     = document.getElementById('grain');
  const glitch    = document.getElementById('glitch');

  // Hide missing optional media gracefully
  [bg, grain, scrambled, glitch].forEach(el => el && el.addEventListener('error', () => (el.style.display='none')));

  // --- Logging helper ---
  const log = (...a) => console.log('[HM]', ...a);

  // --- Detect if letter PNGs exist (case sensitive on GitHub!) ---
  let letterPngsOk = true;
  (function checkLetters(){
    const test = new Image();
    test.onload  = () => { letterPngsOk = true; log('letters/A.png found'); };
    test.onerror = () => { letterPngsOk = false; log('letters/A.png NOT found â€” will use text fallback'); };
    test.src = 'letters/A.png?cachebust=' + Math.random();
  })();

  function clear(layer){ while(layer.firstChild) layer.removeChild(layer.firstChild); }

  function addCharImage(layer, up){
    const img = document.createElement('img');
    img.src = `letters/${up}.png`;
    img.className = 'magnet';
    img.draggable = false;
    const rot = (Math.random()*4 - 2);
    const jitter = (Math.random()*2 - 1);
    img.style.transform = `rotate(${rot}deg)`;
    img.style.marginTop = `${jitter}px`;
    layer.appendChild(img);
  }

  function addCharFallback(layer, up){
    const tile = document.createElement('div');
    tile.textContent = up;
    tile.style.font = 'bold 9vh/1.0 sans-serif';
    tile.style.color = '#d9e2ff';
    tile.style.textShadow = '0 1px 0 rgba(0,0,0,.6)';
    tile.style.userSelect = 'none';
    layer.appendChild(tile);
  }

  function addChar(layer, ch){
    if (ch === ' ') { const s=document.createElement('div'); s.className='spacer'; layer.appendChild(s); return; }
    const up = ch.toUpperCase();
    if (up < 'A' || up > 'Z') { const s=document.createElement('div'); s.className='spacer'; layer.appendChild(s); return; }
    if (letterPngsOk) addCharImage(layer, up); else addCharFallback(layer, up);
  }

  function setScramble(show){ if (scrambled) scrambled.style.opacity = show ? 1 : 0; }

  function renderWord(text){
    log('renderWord:', text);
    setScramble(false);
    clear(wordLayer); clear(ofLayer); clear(suitLayer);
    for (const ch of (text||'').toUpperCase()) addChar(wordLayer, ch);
  }
  function renderCard(value, suit){
    log('renderCard:', value, 'OF', suit);
    setScramble(false);
    clear(wordLayer); clear(ofLayer); clear(suitLayer);
    for (const ch of (value||'').toUpperCase()) addChar(wordLayer, ch);
    for (const ch of 'OF') addChar(ofLayer, ch);
    for (const ch of (suit||'').toUpperCase()) addChar(suitLayer, ch);
  }

  // Glitch wrapper
  let glitchBusy = false;
  function glitchThen(cb){
    if (!glitch || glitch.style.display==='none' || !glitch.src){ cb(); return; }
    if (glitchBusy){ cb(); return; }
    glitchBusy = true;
    glitch.currentTime = 0;
    glitch.style.display = 'block';
    const finish = () => { glitch.pause(); glitch.style.display='none'; glitchBusy=false; cb(); };
    const safety = setTimeout(finish, 1500);
    glitch.onended = () => { clearTimeout(safety); finish(); };
    glitch.play().catch(() => { clearTimeout(safety); finish(); });
  }

  // Ignore first snapshot (no auto-glitch on load)
  let initialized = false;
  let lastSeq = 0;

  onValue(ref(db, 'haunt'), (snap) => {
    const v = snap.val();
    log('firebase snapshot:', v);
    if (!v) return;

    if (!initialized){
      initialized = true;
      lastSeq = Number(v.seq || 0);
      log('initialized, lastSeq=', lastSeq);
      setScramble(true); // start jumble visible
      return;
    }

    const seq = Number(v.seq || 0);
    if (seq <= lastSeq) { log('stale or same seq, ignoring:', seq); return; }
    lastSeq = seq;

    if (v.mode === 'WORD'){
      glitchThen(() => renderWord(v.word || ''));
    } else if (v.mode === 'CARD'){
      glitchThen(() => renderCard(v.value || '', v.suit || ''));
    } else {
      log('unknown mode', v.mode);
    }
  });

  // Rehearsal tap
  document.body.addEventListener('click', () => setScramble(true));

  // --- Expose force helpers in console ---
  window.forceWord = (t='TEST') => { glitchThen(() => renderWord(t)); };
  window.forceCard = (v='ACE', s='HEARTS') => { glitchThen(() => renderCard(v, s)); };
</script>
</body>
</html>
